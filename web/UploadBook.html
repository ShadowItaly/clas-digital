<!doctype html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
		<!--<link rel="stylesheet" href="style.css">-->
		<title>Upload book - clas digital</title>
		<script src="/jszip.js"></script>
		<style>

.biggerPageClass {
	padding-left: 10%;
	padding-right: 10%;
	padding-top: 0.5rem;
	padding-bottom: 2rem;
	overflow: scroll !important;
}

.filesList {
	list-style-type: none;
	width: 100%;
	color: white;
	padding: 0;
}

.filesList>li {
	display: block;
	padding: 2rem;
	background-color: #4682b4;
	border-bottom: 1px solid white;
}

.filesList li p {
	display: block;
	padding-left: 3rem;
	padding-right: 3rem;
	font-size: large;
	vertical-align: center;
	line-height: 1rem;
	color: black;
}

.filesList p progress{
	margin: auto;
}

.filesList>li {
	background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='-2 -2 104 168'><polygon stroke='white' stroke-width='2' fill='none' points='0,0 0,162 100,162 100,40 60,0' /><path stroke='white' stroke-width='2' fill='none' d='M60,0 L60,40 L100,40' /></svg>");
	background-repeat: no-repeat;
	background-size: 2.2rem;
	background-position: 1rem center;
	padding-left:4rem;

}

.filesList>li:first-child {
	background-color: #ccd7ff;
	height: 8rem;
	line-height: 4rem;
	vertical-align: middle;
	text-align: center;
	color: grey;
	border-bottom: none;
	transition: font 0.2s ease;
}

.filesList>li:not(:first-child):hover {
	background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='-2 -2 104 168'><polygon stroke='white' stroke-width='2' fill='none' points='0,0 0,162 100,162 100,40 60,0' /><path stroke='white' stroke-width='2' fill='none' d='M60,0 L60,40 L100,40' /></svg>"),
		url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='-2 -2 104 168'><path stroke='white' stroke-width='2' fill='none' d='M0,20 L100,20'/><polygon stroke='white' stroke-width='2' fill='none' points='10,20 20,162 80,162 90,20'/><path stroke='white' stroke-width='2' fill='none' d='M25,30 L33,155'/><path stroke='white' stroke-width='2' fill='none' d='M42.5,30 L45,155'/><path stroke='white' stroke-width='2' fill='none' d='M58.5,30 L55,155'/><path stroke='white' stroke-width='2' fill='none' d='M75,30 L67,155'/><path stroke='white' stroke-width='2' fill='none' d='M30,20 L35,0 L65,0 70,20'/></svg>");
	background-position: 1rem center, right 1rem center;
}

.saveButton {
	display: block;
	margin: 0 auto;
	height: 4.8rem;
	width: 25rem;
	line-height: 2rem;

}

.pagesRange {
	color: white;
	padding: 1.5rem;
	padding-left: 5rem;
	background-color: #4682b4;
	margin-bottom: 2rem;
	background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='-2 -2 154 186'><polygon stroke='white' stroke-width='2' fill='none' points='50,0  50,50 60,50 100,90 100,132 150,132 150,40 110,0' /><path stroke='white' stroke-width='2' fill='none' d='M110,0 L110,40 L150,40' /><polygon stroke='white' stroke-width='2' stroke-linejoin='bevel' fill='none' points='0,50 0,182 100,182 100,90 60,50' /><path stroke='white' stroke-width='2' fill='none' d='M60,50 L60,90 L100,90' /></svg>");
	background-repeat: no-repeat;
	background-size: 3rem;
	background-position: 1rem center;
}

.hasText {
	color: white;
	padding: 1.5rem;
	padding-left: 5rem;
	background-color: #4682b4;
	margin-bottom: 2rem;
	background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='-2 -2 154 156'><circle cx='50' cy='50' r='50' stroke='white' stroke-width='2' fill='none' /><path stroke='white' stroke-width='2' fill='none' d='M20,30 L80,30'/><path stroke='white' stroke-width='2' fill='none' d='M20,50 L80,50'/><path stroke='white' stroke-width='2' fill='none' d='M20,70 L80,70'/><path stroke='white' stroke-width='2' fill='none' d='M85.0903524534,85.0903524534 L150,150'/></svg>");
	background-repeat: no-repeat;
	background-size: 3rem;
	background-position: 1rem center;
}

.inputStyle {
	width: 80%;
	height: 5vh;
	opacity: 0;
}

.filelist {
	background-color: white;
	color: black;
	border: 2px solid black;
	font-size: small;
	margin-top: 0.1rem;
	margin-bottom: 0.1rem;
}

.filelistcont {
	background-color: grey;
}

.saver {
	width: 100%;
	height: 20%;
	overflow: auto;
	z-index: -1;
	display: block;
	border-radius: 2rem;
	margin-top: 3rem;
}

.progresStyle {
	display: block;
	width: 100%;
	height: 5rem;
	background-color: grey;
}

.internStyle {
	width: 100%;
	height: 100%;
	background-color: green;
	vertical-align: middle;
	line-height: 1rem;
	text-align: center;
	overflow: visible;
}

.progresStyle p {
	display: inline-block;
	color: white;
	font-size: x-large;
	position: relative;
	text-align: center;
	top: 50%;
	transform: translateY(-50%);
}




/*Hides the content that the user cannot access!*/
.classifiedContent {
	display: None;
}

.hideContent {
	display: None;
}


/* The Modal (background) */
.modal {
	display: none; /* Hidden by default */
	position: fixed; /* Stay in place */
	z-index: 1; /* Sit on top */
	left: 0;
	top: 0;
	width: 100%; /* Full width */
	height: 100%; /* Full height */
	overflow: auto; /* Enable scroll if needed */
	background-color: rgb(0,0,0); /* Fallback color */
	background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content/Box */
.modal-content {
	background-color: #fefefe;
	margin: 5% auto; /* 15% from the top and centered */
	padding: 20px;
	border: 1px solid #888;
	width: 80%; /* Could be more or less, depending on screen size */
}

/* The Close Button */
i.close {
	color: #aaa;
	float: right;
	font-size: 28px;
	font-weight: bold;
}

.successwrite {
	color: green;
	float: right;
	margin: 0;
}

.failwrite {
	color: red;
	float: right;
	margin: 0;
}

.close:hover,
.close:focus {
	color: black;
	text-decoration: none;
	cursor: pointer;
} 

.frej {
	background-color: black;
	color: white;
	border: 0;
	padding: 1rem;
	margin: 1rem;
}

		</style>

		<script>
			let jsonZoteroAccess = 0;

//Handles all the User related stuff
class User {
	//Static because it does not matter which user asks to end his session
	static DoLogout() {
		//Just tell the server to log the current user out, then reload the page
		let xhr = new XMLHttpRequest();
		xhr.open("POST","/logout",true);
		xhr.onload = function() {
			window.location.href = "/";
		}
		xhr.send(null);
	}

	static initialise() {
		
		document.getElementById("LoggedInAs").innerHTML = "Logged in as <strong>"+ServerDataObj.user.email+"</strong>";

			let list = document.getElementsByClassName("classifiedContent");
			//Unlocks all the content that the user can access!
			for(var i=0; i < list.length; i++)
			{
				let y = list[i].dataset.acc;
				if((ServerDataObj.user.access&y)!=0)
				{
					list[i].style.display="block";
				}
			}

		let input = document.getElementById("fileUpID");
		input.addEventListener('change',function(e) {
			console.log(e.target.files.length);
			globalFileList = Array.from(e.target.files);
			ShowFiles();
			var waitfor = 0;

			document.getElementById("SaveNow").disabled = true;
			document.getElementById("SaveNow").innerHTML = "Processing input files..";
			for(let i = globalFileList.length-1; i>=0; i--)
			{
				let varstr = globalFileList[i].name.slice(globalFileList[i].name.lastIndexOf("."));
	
				if(varstr=='.zip')
				{
					waitfor++;
					let reader = new FileReader();
					reader.onloadend = function( event ) {
       					 if ( event.target.readyState !== FileReader.DONE ) {
           					 return;
        					}
						let new_zip = new JSZip();
						new_zip.loadAsync(reader.result).then(function(zip){
							for(var x in zip.files)
							{
								zip.files[x].name = x;
								zip.files[x].is_zip_file = true;
								globalFileList.push(zip.files[x]);
							}
							waitfor--;
							if(waitfor==0)
							{
								document.getElementById("SaveNow").disabled = false;
								document.getElementById("SaveNow").innerHTML = "Speichern!";
								ShowFiles();
							}
						});
					}
					reader.readAsArrayBuffer(globalFileList[i]);
				}
				else
				{
					globalFileList[i].reader_callback_func = function(callback,obj) 					{
						let reader= new FileReader();
						reader.onloadend = function(event) {
							if(event.target.readyState !== FileReader.DONE)
								return;
							callback(reader.result);
						}
						reader.readAsArrayBuffer(obj);
					}
				}
			}

			if(waitfor==0)
			{
				document.getElementById("SaveNow").disabled = false;
				document.getElementById("SaveNow").innerHTML = "Speichern!";
			}
		});
	}
}

function DeleteThis(i)
{
	globalFileList.splice(i,1);
	ShowFiles();
}

function ShowFiles()
{
			
			let warning = "";
			for(let i = globalFileList.length-1; i >= 0; i--)
			{
				if(globalFileList[i].name.length < 4)
				{
					globalFileList.splice(i,1);
					continue;
				}
				let varstr = globalFileList[i].name.slice(globalFileList[i].name.lastIndexOf("."));
				if(varstr!='.jpg'&&varstr!='.txt'&&varstr!='.zip')
				{
					globalFileList.splice(i,1);
					continue;
				}
			}

			document.getElementById("FileDropList").innerHTML = "<li onclick='document.getElementById("+"\"fileUpID\""+").click()'>Hier klicken um eine Datei auszuwaehlen</li>";
			for(let i = 0; i < globalFileList.length; i++)
			{
				let list = document.createElement("li");
				
				if(globalFileList[i].is_zip_file !== undefined)
				{
					list.style["background-color"] = "yellow";
					list.style["margin-left"] = "4rem";
				}
				let p = document.createElement("p");
				p.innerHTML = "File selected: "+globalFileList[i].name;

				let prog = document.createElement("progress");
				let span = document.createElement("span");
				prog.style["float"] = "right";
				prog.style["display"] = "inline-block";
				prog["max"] = "100";

				span.innerHTML = "0%";
				span.style["float"] = "right";
				span.style["margin-right"] = "2rem";

				p.appendChild(prog);
				p.appendChild(span);
				list.appendChild(p);
				list.onclick = function(){DeleteThis(i);};
				document.getElementById("FileDropList").appendChild(list);
				globalFileList[i].listentry = list;
				list.progentry = prog;
				list.spanentry = span;
			}
}

let globalFileList = [];

//Create an enum to identify the valid types of State Banner changes
var StateBannerType = {"success":1,"danger":2,"warning":3,"info":4,"release":5};
Object.freeze(StateBannerType);

//Shows a banner at the top of the screen, used to inform the user of errors and success
class StateBanner {
	static ChangeBanner(msg, type)
	{
		//Show the new banner message
		let alt = document.getElementById("StateBanner");
		let newHTML = "<strong>";
		newHTML+= msg;
		newHTML+="</strong>";
		alt.innerHTML = newHTML;

		//Decide what kind of layout the banner should show
		if(type===StateBannerType.success)
		{
			alt.setAttribute("class","alert alert-success");
		}
		else if(type===StateBannerType.danger)
		{
			alt.setAttribute("class","alert alert-danger"); 
		}
		else if(type===StateBannerType.warning)
		{
			alt.setAttribute("class","alert alert-warning"); 
		}
		else if(type===StateBannerType.info)
		{
			alt.setAttribute("class","alert alert-info"); 
		}
		else if(success==StateBannerType.release)
		{
			alt.setAttribute("class","None");
			alt.innerHTML = "";
		}
	}
}

var startUpload = function(){};

function showError(fg,bg,text)
{
	document.getElementById("progressB").style.width = "100%";
	document.getElementById("okka").innerHTML = text;
	document.getElementById("okka").style.color = fg;
	document.getElementById("progressB").style.background = bg;
}

function UploadAll()
{
	let permalink = document.getElementById("Permalink").value;
	let elem = document.getElementById("fileUpID");
	elem.parentNode.removeChild(elem);

	if(permalink=="")
	{
		StateBanner.ChangeBanner("No permalink given!",StateBannerType.danger);
		window.scrollTo(0,0);
		return;
	}
	if(globalFileList.length<1)
	{
		StateBanner.ChangeBanner("No files selected!",StateBannerType.danger);
		window.scrollTo(0,0);
		return;
	}
	console.log("Upload: "+globalFileList.length+" files");

	let xhr = new XMLHttpRequest();
	let requ = "/getBookMetadata";
	let arr = permalink.split("/");
	for(var i = 0; i < arr.length; i++)
	{
		if(arr[i]=="itemKey")
		{
			permalink = arr[i+1];
			break;
		}
	}
	console.log("Extracted item key: "+permalink);
	requ=requ + "?scanId=" +permalink;
	xhr.open("GET",requ,true);
	xhr.onload = function() {
		if(xhr.status != 200)
		{
			showError("black","red",xhr.responseText);
			return;
		}

		console.log(xhr.responseText);
		let js = JSON.parse(xhr.responseText);
		document.getElementById("BookMeta").innerHTML = js.bib;
		let advancedOpts = document.getElementById("ModalBanner");
		//Tell the modal banner it should display itself right now
		advancedOpts.style.display = "block";

		//Prepare the close button, on close click it will hide the modal banner
		let close = document.getElementsByClassName("close")[0];
		close.onclick = function() {
			advancedOpts.style.display = "none";
			showError("black","red","Upload rejected");
			setTimeout(function(){location.reload();},1000);
		}

		//If the user clicked outside of the modal banner close the window as well
		window.onclick = function(event) {
			if (event.target == advancedOpts) {
				advancedOpts.style.display = "none";
				showError("black","red","Upload rejected");
				setTimeout(function(){location.reload();},1000);
			}
		}

		startUpload = function() {	
			document.getElementById('ModalBanner').style.display='none';
			document.getElementById('FileDropList').scrollIntoView();
			for(let x = 0; x < globalFileList.length; x++)
			{
				instaUpload(permalink,globalFileList[x],globalFileList[x].listentry);
			}
		}
		return;
	}
	xhr.send(null);
	console.log(document.getElementById("saver").innerHTML);
}

async function instaUpload2(key,file,outlist)
{
	if(file.cstart_byte === undefined)
		file.cstart_byte = 0;


	let xval = Math.round(file.cstart_byte/file.size*100);
	outlist.progentry.value = xval;
	outlist.spanentry.innerHTML = xval+"%";
	
	let reader = new FileReader();
	let endRead = file.cstart_byte+0x100000+1;
	if(endRead>file.size)
		endRead = file.size;
	let blob = file.slice(file.cstart_byte,endRead);
	
	 reader.onloadend = function( event ) {
        if ( event.target.readyState !== FileReader.DONE ) {
            return;
        }
		
		let xhr = new XMLHttpRequest();
		let requ = "/uploadBook?itemKey="+key+"&filename="+file.name;
		if(file.cstart_byte==0)
		{
			requ+="&operation=begin";
		}
		else if(endRead==file.size)
		{
			requ+="&operation=end";
		}
		xhr.open("POST",requ,true);
		xhr.onload = function() {
			if(xhr.status!=200)
			{
				outlist.innerHTML = "Error the file: "+file.name+"  "+xhr.responseText;
				outlist.style["background-color"] = "red";
				return;
			}
			if(endRead==file.size)
			{
				outlist.style["background-color"] = "green";
				outlist.innerHTML = "Uploaded file: "+file.name+" successfully";
				return;
			}
			file.cstart_byte = endRead;
			instaUpload2(key,file,outlist);
		}
		xhr.send(blob);
	 }
	reader.readAsArrayBuffer(blob);
}

function instaUpload(key,file,outlist)
{
	let checkfile = new XMLHttpRequest();
	let requ_chk = "/getBookRessources?exist_check=true&book="+key+"&ressource="+file.name;
	outlist.progentry.value = "0";
	outlist.spanentry.innerHTML = "0%";
	checkfile.open("GET",requ_chk,true);
	checkfile.onload = function() {
		if(checkfile.status==200)
		{
			outlist.innerHTML = "Error the file: "+file.name+" already exists!";
			outlist.style["background-color"] = "red";
			return;
		}
	let reader = new FileReader();
		//TODO: outlist.
	reader.onload = function() {
		let xhr = new XMLHttpRequest();
		let requ = "/uploadBook?itemKey="+key+"&filename="+file.name;
		xhr.open("POST",requ,true);
		xhr.upload.addEventListener("progress", function(oEvent){
			if(oEvent.lengthComputable)
			{
				let xval = Math.round(oEvent.loaded/oEvent.total*100);
				outlist.progentry.value = xval;
				outlist.spanentry.innerHTML = xval+"%";
			}
		});
		xhr.onload = function() {
			if(xhr.status!=200)
			{
				outlist.innerHTML = xhr.responseText;
				outlist.style["background-color"] = "red";
				return;
			}
			outlist.style["background-color"] = "green";
			outlist.innerHTML = "Uploaded file: "+file.name+" successfully";
		}
		xhr.send(reader.result);
	}
	reader.readAsArrayBuffer(file);
	}
	checkfile.send(null);
}


window.addEventListener("load",User.initialise,false);
		</script>
		<style>
.MetaLayout {
	margin: 3rem;
	margin-bottom: 5rem;
}
.topnav {
	background-color: #333;
	overflow: hidden;
	width: 100%;
	position: fixed;
}

/* Style the links inside the navigation bar */
.topnav a,.topnav .topnav-right a{
	float: left;
	color: #f2f2f2;
	text-align: center;
	padding: 1em 1em;
	text-decoration: none;
	font-size: 1em;
}

/* Change the color of links on hover */
.topnav a:hover {
	transition: all 0.4s ease;
	background-color: #ddd;
	color: black;
}

/* Add a color to the active/current link */
.topnav a.active {
	background-color: #c66900;
	color: white;
}

/* Right-aligned section inside the top navigation */
.topnav-right {
	float: right;
}

.topnav-right button{
	box-sizing: border-box;
	padding: 0.4em 0.8em;
	margin: 0.5em 0.8em;
}

.topnav-right span {
	box-sizing: border-box;
	color: #f2f2f2;
	font-size: 1.2em;
	text-align: center;
	height: 100%;
}

		</style>
	</head>
	<body>
		<!-- The navigation bar config -->
		<div class="topnav">
			<a href="/">Home</a>
			<a href="/search">Search</a>
			<a class="classifiedContent" href="/administration" data-acc=4>Administration</a>
			<a class="classifiedContent active" href="/uploadbook" data-acc=2>Upload Books</a>
			<a class="classifiedContent" href="/managebooks" data-acc=2>Manage Books</a>
			<div class="topnav-right">
				<span id="LoggedInAs">Logged in</span>
				<button id="logoutBut" class="btn btn-outline-info" onclick='User.DoLogout()'>Logout</button>
			</div>
		</div>
		<div id="StateBanner"></div>
		<div class="biggerPageClass">
			<h1>Volltexte hochladen</h1>
			<input class="inputStyle" type="file" id="fileUpID" multiple/>

			<h2><span>1.</span>Wo sind die Dateien?</h2>
			<p>Die Zip-Dateien (nur eine aufeinmal) der Staatsbibliothek müssen zuerst einmal auf den Projekt-Server gelangen. Lade sie von der Bibliothek auf deinen PC und nutze das Feld unten, um sie wieder auszuwählen. Sie werden dann auf den Projekt-Server übertragen.</p>
			<p><strong>Wichtig:</strong> Schließe diesen Tab nicht, während der Upload läuft!</p>
			<ul class="list-group" id="CurrentUploads">
			</ul>
			<ul id="FileDropList" class="filesList">
				<li onclick='document.getElementById("fileUpID").click()'>Hier klicken um eine Datei auszuwaehlen</li>
			</ul>
			<br>
			<h2><span>2.</span>Ist alles korrekt?</h2>
			<div aria-label="Vorhandene Scans" class="pagesRange">Noch keine Scans hochgeladen</div>
			<div aria-label="Durchsuchbarer Text?" class="hasText">Nein, es wurde kein durchsuchbarer Text hochgeladen</div>

			<br>
			<h2><span>3.</span>Welches Werk ist das?</h2>
			<p>Fuege noch den Link zu Zotero ein um das Item spaeter immer korrekt zuordnen zu koennen:</p>
			<input id="Permalink" class="description" type="text" placeholder="Permalink hier einfügen"/>
			<br>
			<h2><span>4.</span>Speichern!</h2>
			<div class="saver" id="saver">
				<p>Speichere diesen Volltext auf dem Projektserver!</p>
				<button id="SaveNow" class="saveButton" onclick="UploadAll()">Speichern!</button>
			</div>
		</div>
		<div id="ModalBanner" class="modal">
			<div class="modal-content">
				<span class="close">&times;</span>
				<h4 id="BookMetaHeader">Are you sure that you are uploading the book</h4>
				<br>
				<div id="BookMeta" class="MetaLayout"></div>
				<br>
				<br>
				<div id="ButtonTypes">
					<button class='btn btn-outline-success my2 my-sm-0 inlineButton' onclick="startUpload();return true">Grant upload</button>
					<button class='btn btn-outline-info my2 my-sm-0 inlineButton' onclick="document.getElementsByClassName('close')[0].click();">Reject upload</button>
				</div>
			</div>
		</div>

	</body>
